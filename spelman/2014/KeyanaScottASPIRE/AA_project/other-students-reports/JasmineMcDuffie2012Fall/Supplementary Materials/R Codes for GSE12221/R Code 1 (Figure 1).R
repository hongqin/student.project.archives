
rm(list=ls())
require(GEOquery)

#http://www.ncbi.nlm.nih.gov/geo/browse/
#GEO2R 
myGSE = "GSE12221"
gset <- getGEO(myGSE, GSEMatrix =TRUE)
if (length(gset) > 1) idx <- grep("GPL90", attr(gset, "names")) else idx <- 1
gset <- gset[[idx]]

ex <- exprs(gset) #This is the expression matrix

#########
# Find out probes and ORFs
dictionary = gset@featureData@data[, c('ID', 'ORF')]  #This is a lookup table for probe ID and ORF 

ORFs = unique(as.character(dictionary$ORF))
yORFs = ORFs[grep( "Y\\w{2}\\d{3}.*", ORFs)]  #these are yeast ORFs
str(yORFs)
#Answer
#chr [1:5667] "YKR009C" ...

setdiff(ORFs, yORFs)
#Answer
#[1]

ORFs = yORFs

#########
# A simple approach to create an expression matrix with ORFs as row names
# This approach takes only one probe for each ORFs, which is often true for cDNA arrays

ex2 = ex[match(ORFs, dictionary$ORF), ]   
rownames(ex2) = ORFs
head(ex2) #Now, expression matrix is named by ORFs
#Answers
#GSM307229 GSM307230
#YKR009C  12.07298  12.30875
#YDL157C  14.70120  14.98841
#YER059W  12.80918  13.12621
#YGL059W  12.12115  12.43317
#YDR481C  13.59872  14.09001
#YML113W  10.74028  11.16662
#GSM307231 GSM307232
#YKR009C  12.01290 11.552204
#YDL157C  14.56177 14.209186
#YER059W  12.72811 12.214799
#YGL059W  12.08167 11.698447
#YDR481C  13.85502 13.440674
#YML113W  10.31263  9.688209
#GSM307233 GSM307234
#YKR009C  11.41148 11.526694
#YDL157C  13.99978 13.991418
#YER059W  11.95768 11.836598
#YGL059W  11.53090 11.563489
#YDR481C  13.23303 13.340395
#YML113W   9.66938  9.964245
#GSM307235 GSM307236
#YKR009C  11.46398 10.582521
#YDL157C  13.83208 13.054433
#YER059W  11.75926 10.871531
#YGL059W  11.75255 11.004202
#YDR481C  13.37000 12.651445
#YML113W  10.27670  9.499065
#GSM307237 GSM307238
#YKR009C  11.14745 10.001750
#YDL157C  13.43467 12.334588
#YER059W  11.33863 10.077097
#YGL059W  11.73020 10.583452
#YDR481C  13.24118 12.098897
#YML113W  10.32440  9.411244
#GSM307239 GSM307240
#YKR009C  11.95039  11.84460
#YDL157C  13.81177  13.87765
#YER059W  12.40950  12.35373
#YGL059W  12.23378  12.24538
#YDR481C  13.41474  13.35582
#YML113W  10.46365  10.52068
#GSM307241 GSM307242
#YKR009C  11.46432 11.393970
#YDL157C  13.46036 13.133067
#YER059W  12.28225 12.479374
#YGL059W  12.08043 12.055206
#YDR481C  13.07391 13.000016
#YML113W   9.86033  9.518096
#GSM307243 GSM307244
#YKR009C 11.044664 11.232274
#YDL157C 12.624265 12.584072
#YER059W 12.201435 12.355477
#YGL059W 11.859075 11.929257
#YDR481C 12.586706 12.662167
#YML113W  8.881338  9.193536
#GSM307245 GSM307246
#YKR009C 10.880699  10.93560
#YDL157C 11.772261  11.48507
#YER059W 12.035436  12.14914
#YGL059W 11.675555  11.59611
#YDR481C 12.341842  12.51909
#YML113W  9.048687   9.05933
#GSM307247 GSM307248
#YKR009C 10.736762 10.652455
#YDL157C 11.226878 11.028455
#YER059W 11.865824 11.628278
#YGL059W 11.377340 11.228248
#YDR481C 12.230003 12.253403
#YML113W  9.119608  9.027064
#GSM307249 GSM307250
#YKR009C  11.37770  11.85654
#YDL157C  14.53468  14.91097
#YER059W  11.82427  12.29593
#YGL059W  10.78571  11.19715
#YDR481C  13.25736  13.75862
#YML113W  11.36139  11.74068
#GSM307251 GSM307252
#YDL157C  14.82208  14.57241
#YER059W  12.26977  11.80193
#YGL059W  11.50485  11.22559
#YDR481C  13.83147  13.45986
#YML113W  10.67686  10.01451
#GSM307253 GSM307254
#YKR009C  11.37134  11.21457
#YDL157C  14.51151  14.17028
#YER059W  11.69652  11.44970
#YGL059W  11.12387  10.97840
#YML113W  10.04106  10.09918
#GSM307255 GSM307256
#YKR009C 10.969444 10.753231
#YDL157C 13.792523 13.450647
#YER059W 11.099568 10.907475
#YGL059W 10.754109 10.792439
#YDR481C 12.641012 12.627351
#YML113W  9.907276  9.799285
#GSM307257 GSM307258
#YKR009C  10.44397 10.209688
#YDL157C  12.96906 12.558617
#YER059W  10.64234 10.252705
#YDR481C  12.31849 12.036554
#YML113W   9.67534  9.909964
#GSM307259 GSM307260
#YKR009C  11.74125  11.60176
#YDL157C  14.34561  14.23791
#YER059W  12.40090  12.25781
#YGL059W  11.53332  11.41742
#YDR481C  13.46940  13.30478
#YML113W  11.59066  11.36922
#GSM307261 GSM307262
#YKR009C  11.02916 10.528499
#YDL157C  13.86689 13.563034
#YER059W  11.51174 11.473560
#YGL059W  11.31280 11.461722
#YDR481C  13.12415 12.815781
#YML113W  10.12372  9.287525
#GSM307263 GSM307264
#YKR009C 10.405787 10.563263
#YDL157C 13.380998 13.210589
#YER059W 11.342299 11.174931
#YGL059W 10.991203 10.805451
#YDR481C 12.675489 12.708104
#YML113W  9.452546  9.992611
#GSM307265
#YKR009C  10.53553
#YDL157C  13.10269
#YER059W  11.14740
#YGL059W  10.68398
#YDR481C  12.67792
#YML113W  10.76917
 
##########
#Another approach is to calculate the average sigals for all the probes in the same ORFs
multipleORFs = NA;
ex3 = ex2 #This is just a template
# orf = 'YLR331C'
for (orf in ORFs) {
  myrows = as.character( dictionary$ID[dictionary$ORF==orf] )
  if (length(myrows) > 1) {
    print (orf)
    multipleORFs = c(multipleORFs, orf)
    ex[myrows, ] = apply(ex[myrows,], 2, mean) 
  }else {
    ex3[orf, ] = ex[myrows[1], ]
  }
}
#Answers
#[1] "YOR072W-B"
#[1] "YDR447C"
#[1] "YAR033W"
#[1] "YDL061C"
#[1] "YGR174W-A"
#[1] "YHL001W"
#[1] "YDL229W"
#[1] "YHR043C"
#[1] "YBL072C"
#[1] "YGL189C"
#[1] "YGR085C"
#[1] "YNR072W"
#[1] "YFL020C"
#[1] "YDR038C"
#[1] "YNL301C"
#[1] "YBR219C"
#[1] "YEL069C"
#[1] "YLR037C"
#[1] "YDL243C"
#[1] "YML026C"
#[1] "YGR118W"
#[1] "YBR048W"
#[1] "YLR388W"
#[1] "YMR230W"
#[1] "YBR089C-A"
#[1] "YOR312C"
#[1] "YIL169C"
#[1] "YLL066W-B"
#[1] "YNL034W"
#[1] "YHL033C"
#[1] "YDL247W"
#[1] "YJL219W"
#[1] "YPL277C"
#[1] "YOL166W-A"
#[1] "YLR157W-C"
#[1] "YBL003C"
#[1] "YGR138C"
#[1] "YNL302C"
#[1] "YER074W"
#[1] "YFR031C-A"
#[1] "YCR107W"
#[1] "YAR075W"
#[1] "YLL025W"
#[1] "YOR293W"
#[1] "YLR466C-B"
#[1] "YBR191W"
#[1] "YMR143W"

multipleORFs = multipleORFs[-1]

######
#normalizaion  
colSums = apply(ex3, 2, sum)
colSums/1E6
#Answers
#GSM307229  GSM307230  GSM307231 
#0.07180930 0.07390113 0.07156943 
#GSM307232  GSM307233  GSM307234 
#0.06869843 0.06755856 0.06769592 
#GSM307235  GSM307236  GSM307237 
#0.06794259 0.06321934 0.06653012 
#GSM307238  GSM307239  GSM307240 
#0.06021063 0.07020621 0.07032211 
#GSM307241  GSM307242  GSM307243 
#0.06852977 0.06788998 0.06539552 
#GSM307244  GSM307245  GSM307246 
#0.06566192 0.06366988 0.06316636 
#GSM307247  GSM307248  GSM307249 
#0.06175253 0.06003009 0.07007905 
#GSM307250  GSM307251  GSM307252 
#0.07267762 0.07144198 0.06835907 
#GSM307253  GSM307254  GSM307255 
#0.06768104 0.06640409 0.06475076 
#GSM307256  GSM307257  GSM307258 
#0.06405782 0.06271755 0.06187079 
#GSM307259  GSM307260  GSM307261 
#0.07122730 0.07045399 0.06739332 
#GSM307262  GSM307263  GSM307264 
#0.06452949 0.06358065 0.06398438 
#GSM307265

ex3norm = ex3
for( col in 1:length(ex3[1,])) {
  ex3norm[,col] = ex3[,col] * max(colSums) / sum(ex3[,col])
}
apply(ex3norm, 2, sum) / max(colSums)
#Answers
#GSM307229 GSM307230 GSM307231 
#1         1         1 
#GSM307232 GSM307233 GSM307234 
#1         1         1 
#GSM307235 GSM307236 GSM307237 
#1         1         1 
#GSM307238 GSM307239 GSM307240 
#1         1         1 
#GSM307241 GSM307242 GSM307243 
#1         1         1 
#GSM307244 GSM307245 GSM307246 
#1         1         1 
#GSM307247 GSM307248 GSM307249 
#1         1         1 
#GSM307250 GSM307251 GSM307252 
#1         1         1 
#GSM307253 GSM307254 GSM307255 
#1         1         1 
#GSM307256 GSM307257 GSM307258 
#1         1         1 
#GSM307259 GSM307260 GSM307261 
#1         1         1 
#GSM307262 GSM307263 GSM307264 
#1         1         1 
#GSM307265 
#1

ex3 = ex3norm 

#########
# now, have a look at the signals
hist(ex3[,1], br=100)
ex4 = log2(ex3)
hist(ex4[,3])
ex4[ex4<0] = NA #remove backgrounds

#############
#calculate coefficient of variation
myVar = apply( ex4, 1, FUN=function(x){var(x, na.rm=T)})
myStddev = sqrt(myVar)
myMean = apply( ex4, 1, FUN=function(x){mean(x, na.rm=T)})
myCV = myStddev / myMean
myarray= data.frame(cbind( myStddev, myMean, myCV))
myarray$ORF = ORFs
myarray = myarray[, c(4, 1:3)]
summary(myarray)
#Answers
#ORF           
#Length:5667       
#Class :character  
#Mode  :character  


#myStddev           myMean     
#Min.   :0.01224   Min.   :3.271  
#1st Qu.:0.03622   1st Qu.:3.558  
#Median :0.05093   Median :3.687  
#Mean   :0.06122   Mean   :3.690  
#3rd Qu.:0.07366   3rd Qu.:3.824  
#Max.   :0.28834   Max.   :4.176  
#myCV         
#Min.   :0.003360  
#1st Qu.:0.009714  
#Median :0.013776  
#Mean   :0.016811  
#3rd Qu.:0.020289  
#Max.   :0.079133  

outfilename = paste(myGSE, "_log2CV.csv", sep='')
write.csv(myarray, "GSE12221_log2CV.csv", row.names=F)
test = read.csv("GSE12221_log2CV.csv", colClasses = c('character', NA, NA, NA))
str(test)
#Anwers
#'data.frame':  5667 obs. of  4 variables:
  #$ ORF     : chr  "YKR009C" "YDL157C" "YER059W" "YGL059W" ...
#$ myStddev: num  0.0285 0.0639 0.0583 0.0668 0.0282 ...
#$ myMean  : num  3.63 3.9 3.7 3.66 3.85 ...
#$ myCV    : num  0.00785 0.01638 0.01574 0.01826 0.00734 ...

hist(test$myCV, br=100)
hist(test$myStddev, br=100)
hist(test$myMean, br=100)
